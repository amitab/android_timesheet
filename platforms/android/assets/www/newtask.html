
<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if IE 9]>    <html class="no-js ie9" lang="en"> <![endif]-->
<!-- Consider adding an manifest.appcache: h5bp.com/d/Offline -->
<!--[if gt IE 9]><!--> <html class="no-js" lang="en" itemscope itemtype="http://schema.org/Product"> <!--<![endif]-->
<head>
	<meta charset="utf-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>TimeSheet</title>
	<meta name="description" content="" />
	<meta name="keywords" content="" />
	<meta name="author" content="">

	<!--<link rel="shortcut icon" href="" type="image/x-icon" />-->

	<!-- Facebook Metadata /-->
	<meta property="fb:page_id" content="" />
	<meta property="og:image" content="" />
	<meta property="og:description" content=""/>
	<meta property="og:title" content=""/>

	<!-- Google+ Metadata /-->
	<meta itemprop="name" content="">
	<meta itemprop="description" content="">
	<meta itemprop="image" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
	<link rel="stylesheet" href="styles/css/gumby.css">
    <link rel="stylesheet" href="styles/font-awesome-4.0.3/css/font-awesome.min.css">
    
</head>

<body>
    <script src="scripts/js/libs/jquery-1.10.1.min.js"></script>
	<script src="scripts/modernizr.custom.js"></script>
    
    <!-- Loading custom js files -->    
    <script src="scripts/jquery.hammer.min.js" ></script>
    <script src="scripts/native5.core.js"></script>
    <script src="scripts/native5.notifications.js"></script>
    <script src="scripts/smart-list.js"></script>
    <script src="scripts/sidebar.js" ></script>
    
<div id="header" style="height: 68px;">
        <div class="wrapper">
            <div class="header-item">
                
                <div class="item">
                    <i class="fa fa-angle-left" id="back"></i>
                </div>
                <div class="item logo">
                    &nbsp;<img src="images/timesheet-logo.png" width="35" alt="">
                </div>
                <div class="item title">
                    <h5>&nbsp;<span id="headertitle">New Task</span></h5>
                    <p class="very-small">&nbsp;&nbsp;<span class="headeremail"></span></p>
                </div>
            </div>
            
           
        </div>
    </div>
    <div id="page-wrap">
    
    <div class="row">
        <div class="eight columns centered">
            <section class="new-task">
                
                <form action="" method="post" id="new-task">
                    
                    <div class="title">
                        <h5>New Task for <span id="projectname"></span></h5>
                    </div>
                    <div class="warnings">
                        
                    </div>
                    <div class="field append">
                        <input class="input" type="text" placeholder="Task Name" name="task_name" id="taskname" >
                        <span class="adjoined"><i class="fa fa-pencil-square-o"></i></span>
                    </div>
                    
                    <div class="field">
                        <label class="medium" for="start_date"><i class="fa fa-clock-o"></i>&nbsp;Start Date : </label>
                        <input name="start_date" type="date" id="startdate">
                    </div>
                    
                    <div class="field">
                        <label class="medium" for="start_time"><i class="fa fa-clock-o"></i>&nbsp;Start Time : </label>
                        <input name="start_time" type="time" id="starttime">
                    </div>
                    
                    <div class="field">
                        <label class="medium" for="end_date"><i class="fa fa-clock-o"></i>&nbsp;End Date : </label>
                        <input name="end_date" type="date" id="enddate">
                    </div>
                    
                    <div class="field">
                        <label class="medium" for="end_time"><i class="fa fa-clock-o"></i>&nbsp;End Time : </label>
                        <input name="end_time" type="time" id="endtime">
                    </div>
                    <div class="field">
                        <textarea class="input textarea" placeholder="Notes" name="notes" id="notes"></textarea>
                    </div>
                    <div class="field">
                        <input class="input first-child" type="hidden" placeholder="Location" name="location" id="location" readonly/>
                    </div>
                </form>
                
            </section>
        </div>
    </div>
    
    <script>
        $(document).ready(function() {
            
            // LOAD USER DETAILS
            
            var user = JSON.parse(localStorage.getItem('user'));
            
            // LOAD SIDEBAR
            
            $('.headeremail').text(user.email);
            $('#headername').text(user.first_name + ' ' + user.last_name);
            $('#headerimage').attr({'src' : user.image});
            
            // LOAD COMPLETE
            
            var pressed = false;
            var headerHandler = function(data) {
                $('#header > .wrapper').append(data.message.header_options);
            };
            
            var headerLoader = app.construct({
                path : 'timesheet',
                method : 'POST',
                url : 'headerdata',
                successHandler : headerHandler
            });
            
            headerLoader.serviceObject.invoke({for: 'timesheets/new_task'});
            
             $.fn.serializeObject = function() {
                var o = {};
                var a = this.serializeArray();
                $.each(a, function() {
                    if (o[this.name] !== undefined) {
                        if (!o[this.name].push) {
                            o[this.name] = [o[this.name]];
                        }
                        o[this.name].push(this.value || '');
                    } else {
                        o[this.name] = this.value || '';
                    }
                });
                return o;
            };
                        
            function getJsonFromUrl() {
                var query = location.search.substr(1);
                var data = query.split("&");
                var result = {};
                for(var i=0; i<data.length; i++) {
                    var item = data[i].split("=");
                    result[item[0]] = item[1];
                }
                return result;
            }
            
            var result = getJsonFromUrl();
            var successHandler = function(data) {
               if(data.message.success == true) {
                    native5.Notifications.show( "Task successfuly created.", {
                        notificationType:'toast',
                        title:'Success',
                        position:'bottom',
                        distance:'0px',
                        timeout: 5000,
                        persistent:false
                    });
                    
                    window.location.href = "sheetdetails.html?id=" + data.message.timesheet_id;
                    return;
                } else if (data.message.success == false) {
                    native5.Notifications.show( "Task creation failed.", {
                        notificationType:'toast',
                        title:'Error',
                        position:'bottom',
                        distance:'0px',
                        timeout: 5000,
                        persistent:false
                    });
                    pressed = false;
                    return;
                } else {
                    $('#projectname').text(data.message.project_name);
                }
            };
            
            var communicator = app.construct({
                path : 'timesheet',
                method : 'POST',
                url : 'timesheets/create_new_task_data',
                successHandler : successHandler
            });
            
            var timesheetId = result['old_timesheet_id']; // OLD TIMESHEET ID
            if(typeof timesheetId === 'undefined') {
                timesheetId = null;
            }
            var projectId = result['project_id'];  // PROJECT ID
            
            var workTime = result['work_time'];  // WORK TIME
            if(typeof workTime === 'undefined') {
                workTime = null;
            } else {
                document.getElementById('startdate').readOnly = true;
                document.getElementById('starttime').readOnly = true;
                document.getElementById('enddate').readOnly = true;
                document.getElementById('endtime').readOnly = true;
            }
            
            // ---------------------------- START TIME ----------------------------------------------------
            
            var startDate = decodeURIComponent(result['start_date']);
            if(typeof startDate === 'undefined') {
                startDate = null;
            } else {
                startDate = startDate.replace(/\+/g, ' ');
                $('#startdate').val(startDate);
            }
            var startTime = decodeURIComponent(result['start_time']);
            if(typeof startTime === 'undefined') {
                startTime = null;
            } else {
                startTime = startTime.replace(/\+/g, ' ');
                $('#starttime').val(startTime);
            }
            
            // ---------------------------- START TIME ----------------------------------------------------
            // ---------------------------- END TIME ----------------------------------------------------
            
            var endDate = decodeURIComponent(result['end_date']);
            if(typeof endDate === 'undefined') {
                endDate = null;
            } else {
                endDate = endDate.replace(/\+/g, ' ');
                $('#enddate').val(endDate);
            }
            var endTime = decodeURIComponent(result['end_time']);
            if(typeof endTime === 'undefined') {
                endTime = null;
            } else {
                endTime = endTime.replace(/\+/g, ' ');
                $('#endtime').val(endTime);
            }
            
            // ---------------------------- END TIME ----------------------------------------------------
            
            communicator.serviceObject.invoke({project_id: projectId});
                    
            var onSuccess = function(position) {
                $('#location').val(position.coords.latitude + ', ' + position.coords.longitude);
            }
            //
            function onError(error) {
                console.log('code: '    + error.code    + '\n' +
                'message: ' + error.message + '\n');
            }
            
            navigator.geolocation.getCurrentPosition(onSuccess, onError);
            
            $(document).hammer().on('tap', 'div#save-form', function(e) {
                e.preventDefault();
                if(!pressed) {
                	pressed = true;
                	var formData = {};
                	formData.task_name = $('input#taskname').val();
                	formData.start_time = $('input#startdate').val() + ' ' + $('input#starttime').val();
                	formData.end_time = $('input#enddate').val() + ' ' + $('input#endtime').val();
                	formData.notes = $('#notes').val();
                	formData.location = $('input#location').val();
                	
	                formData.project_id = projectId;
	                formData.timesheet_id = timesheetId;
	                formData.work_time = workTime;
	                formData.new = true;
	                //console.log(formData);
	                communicator.serviceObject.invoke(formData);
                } else {
                	alert("Please wait for the server to respond.");
                }
            });
            
        });
    </script>
    

    </div>
    
    <div id="sidebar" style="z-index: -2;">
        <div class="nav-wrapper">
            <div class="user">
                <table border="0">
                    <tr>
                        <td class="user-image">
                            <img class="image" src="" alt="" width="100" id="headerimage">
                        </td>
                        <td class="user-details">
                            <h5><span id="headername"></span></h5>
                            <p class="small"><span class="headeremail"></span></p>
                        </td>
                    </tr>
                </table>
            </div>
            <nav class="nav">
                <ul>
                    <li><a href=timesheets.html class="page-link small"><i class="fa fa-puzzle-piece"></i>Timesheets</a>
                    </li><li><a href=projects-test.html class="page-link small"><i class="fa fa-coffee"></i>Projects</a>
                    </li><li><a href=profile-test.html class="page-link small"><i class="fa fa-user"></i>Profile</a>
                    </li><li><a href="#" id="logout" class="page-link small"><i class="fa fa-sign-out"></i>Logout</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
    
  </body>
</html>
